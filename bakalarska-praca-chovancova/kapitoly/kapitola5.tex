% !TeX encoding = UTF-8
% !TeX root = ../main.tex
\chapter{Implementácia vzorovej sady grafických komponentov}

\section{Vzorová sada}
Vzorová sada grafických komponentov SCADA systémov obsahuje:
\begin{itemize}
	\item Thermometer - obrázok \ref{fig:thermometer}
	\item Trojcestný ventil - obrázok \ref{fig:trippleValve}
	\item Mapa Slovenska - obrázok \ref{fig:map}
	\item Prečerpávacia stanica - obrázok \ref{fig:pump}
	\item Prepravný pás - obrázok \ref{fig:belt}
	
\end{itemize}
%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[H]
	\centering
	\includegraphics{obrazky/thermometer}
	\caption{Termometer}
	\label{fig:thermometer}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{obrazky/trippleValve}
	\caption{Trojcestný ventil}
	\label{fig:trippleValve}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{obrazky/map}
	\caption{Mapa Slovenska}
	\label{fig:map}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{obrazky/pump}
	\caption{Prečerpávacia stanica}
	\label{fig:pump}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{obrazky/belt}
	\caption{Prepravný pás}
	\label{fig:belt}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Príklad vytvorenia prečerpávacej stanice v Inkscape}

Nakreslenie jednotlivých častí komponentov prečerpávacej stanice v Inkscape bolo realizované pomocou ľavého bočného panela. Prečerpávacia stanica sa skladá z potrubí, indikátora úrovne hladiny vody, motora, a dvoch symbolov prítoku hladiny. Ako je možné vidieť na obrázku  \ref{picture1}.  


\begin{figure}[H]
	\begin{center}
		\includegraphics[width=0.7\linewidth] {obrazky/pump1.jpg}
		\caption{Grafické prostredie programu Inkscape s nakreslenou prečerpávacou stanicou}
		\label{picture1}
	\end{center}
\end{figure}


\section{Definovanie id v SVG}

Pre ovládanie JavaScriptom je nutné si pozrieť jednotlivé jedinečné identifikačné názvy. V SVG sú označované ako id. V zdrojovom kóde .svg súboru je to označené id="nazovElementu". Na ovládanie časti svg elementu v JavaScripte bude realizované cez CSS selektor, kde pristúpim k id svg cez značku \#. 
Príklad použitia: paper.select("\#ventil"); .


\subsection{Object Properties}
Zistenie id je pomerne jednoduché v Inkscape. Klikneme pravým tlačidlom na daný komponent, ktorého id chceme vedieť, a potom na Objekt Properties.

Po kliknutí sa nám zobrazí okno s názvom Object Properties. 

\begin{figure}[H]
	\begin{center}
		\includegraphics [width=5cm]  {obrazky/obr3.png}
		\caption{Object Properties}
		\label{picture3}
	\end{center}
\end{figure}


Z obrázka č.\ref{picture3} možno vyčítať aké je ID, predvolené sú tam napríklad desc3072. Hodnoty je možné prepísať a zmeniť stlačením tlačidla Set. Pre nás je dôležitá hodnota v kolónke id - ventil. 

V okne Object Properties je možné nastaviť script na animovanie. Po kliknutí na Interactivity sa zobrazia ďalšie kolónky, kde je možné zadať akciu, ktorá má nastať.  


\subsection{XML Editor}
Ďalší spôsob získania informácii o svg cez Inkscape je cez zabudovaný XML Editor.
Stlačením klávesovej skratky SHIFT + CTRL + X, alebo v hornej lište v menu vybrať ponuku Edit a na spodku je XML Editor. Následne sa zobrazí okno, ktoré je na obrázku \ref{xmlEditor}.
\begin{figure}[H]
	\begin{center}
		\includegraphics[width=0.6\linewidth]  {obrazky/XmlEditor2.png}
		\caption{Xml Editor v Inkscape}
		\label{xmlEditor}
	\end{center}
\end{figure}

XML Editor umožní zistiť ID jednotlivých komponentov, ale i hodnoty atribútov. 


\section{Integrácia prečerpávacej stanice pre dynamické ovládanie SVG objektu}

Súborová štruktúra prečerpávacej stanice: 
\begin{itemize}
	\item index.html 
	\item PumpingStation.js
	\item PumpingStation.svg
	\item TestPumpingStation.js
\end{itemize}

\subsection{HTML súbor}
Do HTML súboru index.html pridáme párový tag $<$svg$>$.  Na toto miesto sa neskôr vykreslí SVG načítané zo súboru cez JavaScript. Môže sa tu uviesť i celý kód SVG obrázka. V prípade, že nebude v dokumente dané kde presne sa nachádza SVG tag tak sa pridá na najbližšie voľné miesto. 
\subsection{Kód}
\begin{lstlisting}
<svg 
	id="svgStanica" 
	viewBox="0 0 750 600" 
	width="40%" 
	height="40%"> 
</svg>
\end{lstlisting}

\subsection{Vysvetlenie kódu}
Atribúty v tagu sú prispôsobené na to, aby sa grafický element vykreslil responzívne na obrazovku.
\begin{itemize}
\item  \textbf{id} - jedinečný identifikátor, cez ktorý meníme vlastnosti.
\item 	\textbf{viewBox} - je virtuálne okno, ktorým sa užívateľ uvidí svg obrázok. Je atribút, ktorý povoľuje špecifikovať danú množinu grafických komponentov, aby sa zobrazili v daných súradniciach x, y a šírke, výške. Hodnoty atribútov v viewBox sú štyri čísla - min-x, min-y, width a height. 
\item 	\textbf{width} a \textbf{height} je šírka a výška. Hodnoty atribútov je možné uviesť relatívne v percentách, alebo absolútne v pixloch. 
\end{itemize}

Do HTML dokumentu sa pridajú jednotlivé JavaScriptové knižnice s ktoré bude daný grafický komponent používať. 
\begin{lstlisting}[language = HTML]
<script type="text/javascript" src="../js/snap.svg-min.js">
</script>
<script type="text/javascript" src="PumpingStation.js">
</script>
\end{lstlisting}

Musíme sa uistiť, aby sa načítali všetky JavaScriptové knižnice, pred spustením funkcií. To zabezpečíme pridaním  onload do tagu $<$body$>$. 
\begin{lstlisting}
	<body onload="onPageLoad();">
\end{lstlisting}



\section{PumpingStation.js}
V súbore PumpingStation.js sú metódy na vizualizáciu grafického komponentu. V tejto časti je popis jednotlivých funkcií. 

\subsection{onPageLoad()}
onPageLoad() sa spustí pri načítaní tela HTML súboru index.html. Následne spustí  PumpingStation(par1,, par2). Prvý parameter je udaný svg súbor vytvorení programom Inkscape. Druhý parameter je id tagu svg, kde sa vykreslí prečerpávacia stanica.

\begin{lstlisting}
function onPageLoad() {
	PumpingStation("PumpingStation.svg", "#svgStanica" );
}
\end{lstlisting}

\subsection{PumpingStation(par1, par2)}

Parametre pre PumpingStation sú názov svg súboru, a id, ktoré sa nachádza v tagu $<$svg$>$ html súbore.

Vo vnútri PumpingStation sa nachádza inicializácia globálnych atribútov. 
\begin{lstlisting}
var paper;
var idValve, idValve1 idNadrz, idHladina, idEngineMotor;

function PumpingStation(nazovFileSVG, idDOMsvgElement) {
	paper = Snap(idDOMsvgElement);
	Snap.load(nazovFileSVG, function (f) {
		idHladina = "#hladina";
		idNadrz = "#nadrz";
		idValve = "#ventil";
		idValve2 = "#ventil2";
		idEngineMotor = "#engineMotor";
		paper.append(f);
	});
}
\end{lstlisting}

Atribút paper je globálna premenná cez ktorú sa bude pristupovať k metódam JavaScriptovej knižnice Snap.svg. Jej parameter je referencia na plochu, kde bude vykreslené SVG elementy.

Vo vnútri funkcie volám z Snap.svg API funkciu load(). Má parametre názov súboru, a funkciu, ktorú spustí následne po načítaní. 
Vo vnútri funkcie load() sa inicializujú globálne premenné.  
Premenné obsahujú CSS selektor id získaný z programu Inkscape. Premenné budú slúžiť ako parameter pri volaní funkcie paper.select(). Pre prípadné zmeny v id, sa dané id zmení na jednom mieste a nemusí sa prepisovať všade. 

Význam premenných je nasledový: 
\begin{itemize}
	\item idHladina - indikátor prítoku hladiny vody, 
	\item idNadrz - je miesto, kde bude prichádzať prítok vody,
	\item idValve1, idValve2 - je ventil, 
	\item idEngineMotor - je symbol rotora motora.
\end{itemize}

Načítaný .svg súbor sa zobrazí volaním metódy append. 

\subsection{animateTank(percento)}
V tejto metóde je zobrazená vizualizácia prítoku hladiny do nádrže. Ako parameter slúži percento vyplnenia. 

\begin{lstlisting}
function animateTank(percento){
	var height = paper.select(idNadrz).getBBox().height;
	var y = paper.select(idNadrz).getBBox().y;
	var newHeight = height * (percento/100);
	var newY = y + height - newHeight;
	
	paper.select(idHladina).animate({
	y: newY,
	height: newHeight
	}, 1000);
}
\end{lstlisting}

Animovanie je realizované cez metódu animate zo Snap.svg API. 
Význam lokálnych premenných: 
\begin{itemize}
	\item height - výška nádrže do, ktorej bude pritekať voda,  získaná volaním metódy getBBox(),
	\item y - súradnica y - navýšením, alebo znížením hladiny sa mení súradnica y, a x zostava nezmenená,
	\item newHeight - vypočítaná nová výška hladiny podľa daného percenta, 
	\item newY - je vypočítaná súradnica - osi y. 
\end{itemize}

Volaním metódy animate, sa zanimuje daný element, v tomto prípade to bude hladina nádrže. Metóda má nasledovné parametre: \begin{itemize}
	\item atribúty - v pároch udané atribúty, ktoré sa zmenia. Zmení sa iba výška a os y, ostatné atribúty zostávajú nezmenené.
	\item rýchlosť animácie udaná v milisekundách. 
\end{itemize}

 
\subsection{openValve1(isOpen)}
Indikátor prítoku hladiny do prečerpávacej stanice je ventil, ktorý mení farbu. Ak je nastavený parameter isOpen na true, tak farba ventila bude zelená, v inom prípade červená. 
Zmena farby je realizovaná volaním metódy attr zo Snap.svg API, ktorá nastavila atribút fill daného elementu na danú farbu. Farba zmeny je zapísaná termálnym operátorom. 
Pre zmenu farby v druhom elemente je zápis identický až na to, že je zmena pri volaní select - na idValve2. 
\begin{lstlisting}
function openValve1(isOpen){
	paper.select(idValve).attr({
	fill: ((isOpen === "true") ?   "green" : "red")
	});
}
\end{lstlisting}






\begin{lstlisting}
var isPaused = true;
var animationRunning = false;
function rotateEngine(isRotating){
	isPaused = isRotating;

	function toggleRotation() {
		if (!animationRunning && isPaused) {
			isPaused = false;
			rotateLeft(paper.select(idEngineMotor));
		} else {
			isPaused = true;
		}
	}
	toggleRotation();

	function rotateLeft(element) {
		animationRunning = true;
		element.transform(
		("R0,"+ element.getBBox().cx + ","+ element.getBBox().cy));

	if (!(isPaused)) {
		element.animate({
		 transform: ("R360,"+ element.getBBox().cx + ","+  element.getBBox().cy )
		 },2000, 
		 mina.linear, 
		 rotateLeft.bind(null, element));
		} else { animationRunning = false;}
	}
}
\end{lstlisting}
\caption{Metóda rotateEngine(isRotating)}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%






